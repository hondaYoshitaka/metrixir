<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">

    <script src="/assets/js/jquery-3.2.1.min.js"></script>
    <script>
        $(function () {
            var tbody = $('#table-metrics tbody');
            var transactions = $('.each-page-transaction');

            var records = [];

            transactions.each(function () {
                var metricsList = $(this).find('.metrics');

                var first = metricsList.first();
                var last = metricsList.last();

                var status = (function (elm) {
                    switch (elm.data('event-name')) {
                        case 'submit':
                            return 'complete';
                        case 'unload':
                            return 'leave';
                        default:
                            return 'staying';
                    }
                })(last);
                // 同一トランザクション内は同じページのはずなので
                // 任意の要素から取り出す
                var path = first.data('path');
                var total = ( new Date(last.data('client-at')).getTime() - new Date(first.data('client-at')).getTime() ) / 1000;

                records.push({status: status, path: path, total: total});
            });

            for (var index in records) {
                var contents = [
                    records[index].status,
                    records[index].path,
                    '-',
                    records[index].total
                ];
                var tr = $('<tr/>');

                for (var contentIdx in contents) {
                    tr.append($('<td/>').append(contents[contentIdx]));
                }
                tbody.append(tr);
            }
        });
    </script>

    <title>Host Metrics | Metrixir</title>
</head>

<body>
<div class="container">
    <h2 th:text="${host.host}"></h2>
    <h4 th:text="${host.tag}"></h4>

    <!-- トランザクション毎 -->
    <section class="row">
        <div class="each-page-transaction" th:each="entry : ${metricsMap}">
            <span class="metrics"
                  th:each="metrics : ${entry.value}" th:object="${metrics}"
                  th:data-path="*{path}" th:data-input-name="*{name}"
                  th:data-event-name="*{event}" th:data-client-at="*{clientEventAt}"></span>
        </div>

        <table id="table-metrics">
            <thead>
            <tr>
                <th>status</th>
                <th>path</th>
                <th>detail</th>
                <th>total (秒)</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>
</div>
</body>
</html>