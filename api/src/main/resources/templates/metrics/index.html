<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/js/vis/dist/vis.min.css">

    <script src="/assets/js/jquery-3.2.1.min.js"></script>
    <script src="/assets/js/vis/dist/vis.min.js"></script>
    <script>
        $(function () {
            var container = $('#timeline');
            var visitorSelect = $('select[name="visitorId"]');

            var options = {
                orientation: 'top',
                width: '100%',
                margin: {
                    item: 5
                },
                zoomMax: 6 * 60 * 60 * 1000,
                zoomMin: 10 * 1000
            };

            visitorSelect.on('change', function () {
                var select = $(this);

                var visitorId = select.val();
                if (!visitorId) {
                    return select;
                }
                $.ajax({
                    type: 'GET',
                    url: '/api/metrics?visitorId=' + visitorId + '&tag=' + $('body').data('tag'),
                    dataType: 'json'
                }).done(function (response) {
                    var groups = [];
                    var items = [];

                    var groupIndex = 0;

                    for (var key in response.metricsMap) {
                        var groupingMetrics = response.metricsMap[key];

                        groups.push({
                            id: groupIndex,
                            content: key
                        });
                        for (var itemIndex in groupingMetrics) {
                            var metrics = groupingMetrics[itemIndex];

                            var start = new Date(metrics.start), end = new Date(metrics.end);

                            items.push({
                                group: groupIndex,
                                content: (end.getTime() - start.getTime()) / 1000 + ' sec',
                                start: start,
                                end: end
                            });
                        }
                        groupIndex++;
                    }
                    container.empty();

                    new vis.Timeline(container.get(0), items, groups, options);
                });
            });

        });
    </script>

    <title>Metrics | Metrixir</title>
</head>
<body th:data-tag="${tag}">
<div class="container">
    <h2 th:text="${tag}"></h2>
    <section>
        <div class="form-group">
            <label for="visitor-id">訪問者ID</label>
            <select name="visitorId" id="visitor-id" class="form-control">
                <option value="">-- 未選択 --</option>
                <option th:each="visitor : ${visitors}" th:object="${visitor}" th:text="*{id}">
                    <span th:text="*{id}"></span>
                </option>
            </select>
            <small class="form-text text-muted">登録ページを操作した訪問ユーザを特定するためのコード.</small>
        </div>
    </section>
    <section class="row">
        <div id="timeline" class="col-lg-12"></div>
    </section>
</div>
</body>
</html>